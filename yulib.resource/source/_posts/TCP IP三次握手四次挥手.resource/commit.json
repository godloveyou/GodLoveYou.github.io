{"compress":true,"commitItems":[["8cad2e21-d973-4dc8-af17-c60360b20ea3",1570501821519,"",[[1570501772078,["david@DESKTOP-9844NL4",[[1,0,"# TCP IP三次握手四次挥手\n\n\n\n"]],[0,0],[19,19]]],[1570501796521,["david@DESKTOP-9844NL4",[[-1,0,"# TCP IP三次握手四次挥手"],[1,16,"---\ntitle: 微信小程序获取openid\ncategories: 微信小程序\ntags: 微信小程序\n---"]],[0,16],[58,58]]],[1570501799216,["david@DESKTOP-9844NL4",[[-1,11,"微信小程序获取openid"]],[11,24],[11,11]]],[1570501808199,["david@DESKTOP-9844NL4",[[1,11,"TCP/IP三次握手四次挥手"]],[11,11],[25,25]]],[1570501810025,["david@DESKTOP-9844NL4",[[-1,38,"微信小程序"]],[43,43],[38,38]]],[1570501811820,["david@DESKTOP-9844NL4",[[1,38,"TR"]],[38,38],[40,40]]],[1570501812534,["david@DESKTOP-9844NL4",[[-1,39,"R"]],[40,40],[39,39]]],[1570501812932,["david@DESKTOP-9844NL4",[[1,39,"CP"]],[39,39],[41,41]]],[1570501816284,["david@DESKTOP-9844NL4",[[-1,48,"微信小程序"]],[48,53],[48,48]]],[1570501818538,["david@DESKTOP-9844NL4",[[1,48,"TCP/IP"]],[48,48],[54,54]]],[1570501821684,["david@DESKTOP-9844NL4",[[1,62,"\n"]],[58,58],[59,59]]],[1570501821883,["david@DESKTOP-9844NL4",[[1,63,"\n"]],[59,59],[60,60]]],[1570501823406,["david@DESKTOP-9844NL4",[[1,60,"---\ntitle: 微信小程序获取openid\ncategories: 微信小程序\ntags: 微信小程序\n---"]],[60,60],[118,118]]],[1570501825803,["david@DESKTOP-9844NL4",[[-1,60,"---\ntitle: 微信小程序获取openid\ncategories: 微信小程序\ntags: 微信小程序\n---"]],[118,118],[60,60]]],[1570501944977,["david@DESKTOP-9844NL4",[[1,60,"**一、TCP报文格式**\n\n  TCP报文格式图：\n\n![](http://dl2.iteye.com/upload/attachment/0108/8317/ef70c29e-651b-33a4-b188-d4e8e0ff9915.png) \n\n  上图中有几个字段需要重点介绍下：\n\n  （1）序号：Seq序号，占32位，用来标识从TCP源端向目的端发送的字节流，发起方发送数据时对此进行标记。\n\n  （2）确认序号：Ack序号，占32位，只有ACK标志位为1时，确认序号字段才有效，Ack=Seq+1。\n\n  （3）标志位：共6个，即URG、ACK、PSH、RST、SYN、FIN等，具体含义如下：\n\n  （A）URG：紧急指针（urgent pointer）有效。\n\n  （B）ACK：确认序号有效。\n\n  （C）PSH：接收方应该尽快将这个报文交给应用层。\n\n  （D）RST：重置连接。\n\n  （E）SYN：发起一个新连接。\n\n  （F）FIN：释放一个连接。"]],[60,60],[497,497]]],[1570502011495,["david@DESKTOP-9844NL4",[[1,501,"\n"]],[498,498],[499,499]]],[1570502011691,["david@DESKTOP-9844NL4",[[1,502,"\n"]],[499,499],[500,500]]],[1570502013552,["david@DESKTOP-9844NL4",[[-1,75," "],[1,76," "],[-1,182," \n\n "],[1,186," \n\n "],[-1,205," "],[1,206," "],[-1,262," "],[1,263," "],[-1,317," "],[1,318," "],[-1,365," "],[1,366," "],[-1,399," "],[1,400," "],[-1,417," "],[1,418," "],[-1,446," "],[1,447," "],[-1,462," "],[1,463," "],[-1,481," "],[1,482," "],[1,500,"SAN"]],[500,500],[503,503]]],[1570502014347,["david@DESKTOP-9844NL4",[[-1,500,"SAN"]],[503,503],[500,500]]],[1570502016325,["david@DESKTOP-9844NL4",[[1,500,"三次握手"]],[500,500],[504,504]]],[1570502016724,["david@DESKTOP-9844NL4",[[1,507,"\n"]],[504,504],[505,505]]],[1570502020394,["david@DESKTOP-9844NL4",[[1,505,"第一次握手"]],[505,505],[510,510]]],[1570502021328,["david@DESKTOP-9844NL4",[[1,513,"\n"]],[510,510],[511,511]]],[1570502022260,["david@DESKTOP-9844NL4",[[1,511,"![mark](http://blog.sjjtcloud.com/blog/20191008/Ehi1C1a26vPG.png?imageslim)"]],[511,511],[586,586]]],[1570502026642,["david@DESKTOP-9844NL4",[[1,589,"\n"]],[586,586],[587,587]]],[1570502026838,["david@DESKTOP-9844NL4",[[1,590,"\n"]],[587,587],[588,588]]],[1570502029633,["david@DESKTOP-9844NL4",[[1,588,"第二次握手"]],[588,588],[593,593]]],[1570502029932,["david@DESKTOP-9844NL4",[[1,596,"\n"]],[593,593],[594,594]]],[1570502608611,["david@DESKTOP-9844NL4",[[-1,511,"![mark](http://blog.sjjtcloud.com/blog/20191008/Ehi1C1a26vPG.png?imageslim)"]],[511,586],[511,511]]],[1570502609012,["david@DESKTOP-9844NL4",[[1,511,"![mark](http://blog.sjjtcloud.com/blog/20191008/4gfW0vbr3WOE.png?imageslim)"]],[511,511],[586,586]]],[1570502612926,["david@DESKTOP-9844NL4",[[1,597,"\n"]],[593,593],[594,594]]],[1570502690838,["david@DESKTOP-9844NL4",[[1,594,"![mark](http://blog.sjjtcloud.com/blog/20191008/d5nltEXPMxL5.png?imageslim)"]],[594,594],[669,669]]],[1570502694507,["david@DESKTOP-9844NL4",[[1,510," S "]],[510,510],[513,513]]],[1570502694996,["david@DESKTOP-9844NL4",[[-1,512," "]],[513,513],[512,512]]],[1570502695672,["david@DESKTOP-9844NL4",[[1,512,"YN"]],[512,512],[514,514]]],[1570502705052,["david@DESKTOP-9844NL4",[[1,597," SYN,ACK"]],[597,597],[605,605]]],[1570502707140,["david@DESKTOP-9844NL4",[[1,685,"\n"]],[681,681],[682,682]]],[1570502707306,["david@DESKTOP-9844NL4",[[1,686,"\n"]],[682,682],[683,683]]],[1570502707778,["david@DESKTOP-9844NL4",[[1,683,"D"]],[683,683],[684,684]]],[1570502708126,["david@DESKTOP-9844NL4",[[-1,683,"D"]],[684,684],[683,683]]],[1570502711866,["david@DESKTOP-9844NL4",[[1,683,"第三次握手 "]],[683,683],[689,689]]],[1570502942883,["david@DESKTOP-9844NL4",[[1,693,"\n"]],[689,689],[690,690]]],[1570502943345,["david@DESKTOP-9844NL4",[[1,690,"![mark](http://blog.sjjtcloud.com/blog/20191008/ppSYnlie7IQE.png?imageslim)"]],[690,690],[765,765]]],[1570502945106,["david@DESKTOP-9844NL4",[[1,505,"\n"]],[504,504],[505,505]]],[1570502945285,["david@DESKTOP-9844NL4",[[1,506,"\n"]],[505,505],[506,506]]],[1570502950724,["david@DESKTOP-9844NL4",[[1,504,"用win"]],[504,504],[508,508]]],[1570502963321,["david@DESKTOP-9844NL4",[[-1,507,"n"]],[508,508],[507,507]]],[1570502964903,["david@DESKTOP-9844NL4",[[1,507,"resh"]],[507,507],[511,511]]],[1570502969392,["david@DESKTOP-9844NL4",[[1,511,"ark抓包分析结果"]],[511,511],[520,520]]],[1570502971416,["david@DESKTOP-9844NL4",[[-1,518,"结果"]],[520,520],[518,518]]],[1570502971783,["david@DESKTOP-9844NL4",[[1,521,"\n"]],[518,518],[519,519]]],[1570503054058,["david@DESKTOP-9844NL4",[[1,519,"![mark](http://blog.sjjtcloud.com/blog/20191008/XjQC8Jd9LHcm.png?imageslim)"]],[519,519],[594,594]]],[1570515005590,["david@DESKTOP-9844NL4",[[1,861,"\n"]],[857,857],[858,858]]],[1570515005812,["david@DESKTOP-9844NL4",[[1,862,"\n"]],[858,858],[859,859]]],[1570515006025,["david@DESKTOP-9844NL4",[[1,863,"\n"]],[859,859],[860,860]]],[1570515006203,["david@DESKTOP-9844NL4",[[1,864,"\n"]],[860,860],[861,861]]],[1570515006396,["david@DESKTOP-9844NL4",[[1,865,"\n"]],[861,861],[862,862]]],[1570515029192,["david@DESKTOP-9844NL4",[[1,866,"\n"]],[858,858],[859,859]]],[1570515029389,["david@DESKTOP-9844NL4",[[1,867,"\n"]],[859,859],[860,860]]],[1570515030721,["david@DESKTOP-9844NL4",[[1,860,"森次"]],[860,860],[862,862]]],[1570515031498,["david@DESKTOP-9844NL4",[[-1,860,"森次"]],[862,862],[860,860]]],[1570515036576,["david@DESKTOP-9844NL4",[[1,860,"三次握手与四次"]],[860,860],[867,867]]],[1570515037127,["david@DESKTOP-9844NL4",[[-1,864,"与四次"]],[867,867],[864,864]]],[1570515037574,["david@DESKTOP-9844NL4",[[1,872,"\n"]],[864,864],[865,865]]],[1570515050050,["david@DESKTOP-9844NL4",[[1,865,"# TCP 三次握手 示意图\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102251716-1929749101.png)\n\n## Wireshark 抓包注意事项\n\n为了演示一个TCP三次握手建立连接的过程，我们通过 Chrome 访问一个网页。 \n已知 HTTP 协议就是建立在TCP链接上的\n\n比如访问以下的网址： \n[http://toutiao.newmedia139.net/](http://toutiao.newmedia139.net/)\n\n通过 Cmd 的 ping 命令获取 这个网站对应的 IP地址 **183.136.236.13** \n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102251934-555170248.png)\n\n确定 这个IP 有一个非常重要的好处，就是我们只需要\n\n电脑 -> 网站 的数据包\n\n网站->电脑 的数据包\n\n所以，可以使用Wireshark的显示过滤规则，只显示我们需要的数据，不然你一定看着满屏幕的数据抓狂的。\n\n### 过滤规则如下：\n\nip.src==183.136.236.13 or ip.dst==183.136.236.13\n\n### 截图：\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102252371-1979969603.png)\n\n## 分析TCP握手包\n\n## 概览\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102252636-937376226.png)\n\n通过图片，可以看到 先 进行了 TCP 三次传输 然后才 开始 HTTP 传输\n\n## 第一次 客户端发送 SYN 报文 到服务器\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102253092-1365683710.png)\n\n## 第二次 ，服务器接收到 客户端的SYN 报文，回复 SYN + ACK 报文\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102253605-1241059132.png)\n\n## 第三次 ，客户端接收到服务端的 SYN+ACK 报文后，回复 ACK报文\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102254051-694072128.png)\n\n## 注意：\n\n这里有个坑：Wireshark 显示的 Syn Ack的数目是不准确的\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102254264-644298919.png)\n\n理论上，Syn 应该初始值是个随机数的，后面的要根据初始值增加 \n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102254468-1577667548.png)\n\n## TCP 三次握手总结\n\n建立一个稳定的 双向 连接，最少需要 几次 通信呢？ \n以打电话为例 \n小明 给小红 打电话 \n小明 ： 喂，小红 听得到么？ \n小红： 嗯，我听到你说话了，你能听到我么？ \n小明：我能听到你。\n\n只有这三个传输都正确了，才能保障双方是 连通的\n\n# TCP 四次挥手\n\n由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。这个原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。\n\nCP的连接的拆除需要发送四个包，因此称为四次挥手(four-way handshake)。客户端或服务器均可主动发起挥手动作，在socket编程中，任何一方执行close()操作即可产生挥手操作。\n\n（1）客户端A发送一个FIN，用来关闭客户A到服务器B的数据传送。\n\n（2）服务器B收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。\n\n（3）服务器B关闭与客户端A的连接，发送一个FIN给客户端A。\n\n（4）客户端A发回ACK报文确认，并将确认序号设置为收到序号加1。\n\nTCP采用四次挥手关闭连接如图2所示。\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102255109-43618668.png)\n\n# 抓包截图\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102255513-104940885.png)\n\n其中 183.136.236.13 是服务器的ip \n可以看到 这一次挥手是由 服务器 发起的\n\n## 第一次挥手 FIN +ACK\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102255745-1296704292.png)\n\n## 第二次挥手 ACK\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102255981-1871970231.png)\n\n## 第三次挥手 FIN +ACK\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102256594-1733317431.png)\n\n## 第四次挥手 ACK\n\n![](https://images2018.cnblogs.com/blog/701983/201803/701983-20180314102257013-202026294.png)\n\n## 总结\n\nTCP 由于是全双工的，断开链接需要四次挥手"]],[865,865],[3694,3694]]],[1570515052701,["david@DESKTOP-9844NL4",[[-1,860,"三次握手"],[1,864,"、"],[-1,1038," "],[1,1039," "],[-1,1074," "],[1,1075," "],[-1,1175," "],[1,1176," "],[-1,1194," "],[1,1195," "],[-1,2293," "],[1,2294," "],[-1,2432," "],[1,2433," "],[-1,2440," "],[1,2441," "],[-1,2452," "],[1,2453," "],[-1,2469," "],[1,2470," "],[-1,2492," "],[1,2493," "],[-1,3192," "],[1,3193," "]],[860,860],[861,861]]],[1570515053205,["david@DESKTOP-9844NL4",[[-1,860,"、"]],[861,861],[860,860]]],[1570515053243,["david@DESKTOP-9844NL4",[[1,860,"、"]],[860,860],[861,861]]],[1570515053782,["david@DESKTOP-9844NL4",[[-1,860,"、"]],[861,861],[860,860]]]],null,"david@DESKTOP-9844NL4"]]}